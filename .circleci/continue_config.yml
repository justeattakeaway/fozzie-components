# version: 2.1 # use CircleCI 2.1
#
# Check https://circleci.com/docs/2.0/language-javascript/ for more details
#
version: 2.1

orbs:
  slack: circleci/slack@4.1.3

# the default pipeline parameters, which will be updated according to
# the results of the path-filtering orb
parameters:
  global_change:
    type: boolean
    default: false

commands:
  set_deploy_key:
    description: Sets the ssh key for project access
    steps:
      - add_ssh_keys:
          fingerprints:
            - "0e:50:82:ad:81:17:a5:31:04:13:fd:6e:c7:72:c9:18"

  install_node_dependencies:
    description: Installs the node dependencies
    steps:
      - run:
          name: Install node dependencies
          command: yarn install --frozen-lockfile --cache-folder ~/.cache/yarn
  
  run_command:
    parameters:
      command_description:
        type: string
      command_name:
        type: string
    description: Runs commands based on passed parameters
    steps:
      - when:
          condition: << pipeline.parameters.global_change >>
          steps:
            - run:
                name: << parameters.command_description >>
                command: yarn << parameters.command_name >>
      - when:
          condition:
            not: << pipeline.parameters.global_change >> 
          steps:
            - run:
                name: << parameters.command_description >>
                command: yarn << parameters.command_name >> --since master...HEAD

  save_cache_dist_directories:
    description: Saves cache for dist directories
    steps:
      - save_cache:
          name: Cache for molecules
          key: build-cache-molecules-{{ .Branch }}-{{ .Revision }}
          paths:
            - packages/tools/f-vue-icons/dist
            - packages/components/molecules/f-alert/dist
            - packages/components/molecules/f-breadcrumbs/dist
            - packages/components/molecules/f-card-with-content/dist
            - packages/components/molecules/f-media-element/dist
            - packages/components/molecules/f-mega-modal/dist
            - packages/components/molecules/f-navigation-links/dist
            - packages/components/molecules/f-promotions-showcase/dist
            - packages/components/molecules/f-restaurant-card/dist
            - packages/components/molecules/f-searchbox/dist
            - packages/components/molecules/f-skeleton-loader/dist
            - packages/components/molecules/f-tabs/dist
            - packages/components/molecules/f-user-message/dist

      - save_cache:
          name: Cache for atoms
          key: build-cache-atoms-{{ .Branch }}-{{ .Revision }}
          paths:
            - packages/components/atoms/f-button/dist
            - packages/components/atoms/f-card/dist
            - packages/components/atoms/f-error-message/dist
            - packages/components/atoms/f-form-field/dist
            - packages/components/atoms/f-link/dist
            - packages/components/atoms/f-popover/dist
            - packages/components/atoms/f-image-tile/dist
            - packages/components/atoms/f-spinner/dist
            - packages/components/atoms/f-error-boundary/dist
            - packages/components/atoms/f-filter-pill/dist

      - save_cache:
          name: Cache for organisms
          key: build-cache-organisms-{{ .Branch }}-{{ .Revision }}
          paths:
            - packages/components/organisms/f-content-cards/dist
            - packages/components/organisms/f-cookie-banner/dist
            - packages/components/organisms/f-footer/dist
            - packages/components/organisms/f-form/dist
            - packages/components/organisms/f-header/dist
            - packages/components/organisms/f-status-banner/dist

      - save_cache:
          name: Cache for templates
          key: build-cache-templates-{{ .Branch }}-{{ .Revision }}
          paths:
            - packages/components/templates/f-template-subnav/dist

      - save_cache:
          name: Cache for pages
          key: build-cache-pages-{{ .Branch }}-{{ .Revision }}
          paths:
            - packages/components/pages/f-checkout/dist
            - packages/components/pages/f-contact-preferences/dist
            - packages/components/pages/f-loyalty/dist
            - packages/components/pages/f-offers/dist
            - packages/components/pages/f-registration/dist
            - packages/components/pages/f-takeawaypay-activation/dist
            - packages/components/pages/f-account-info/dist

      - save_cache:
          name: Cache for services
          key: build-cache-services-{{ .Branch }}-{{ .Revision }}
          paths:
            - packages/services/f-analytics/dist
            - packages/services/f-braze-adapter/dist
            - packages/services/f-compatibility/dist
            - packages/services/f-consumer-oidc/dist
            - packages/services/f-development-context/dist
            - packages/services/f-feature-management/dist
            - packages/services/f-globalisation/dist
            - packages/services/f-http/dist
            - packages/services/f-services/dist
            - packages/services/f-performance/dist
            - packages/services/f-statistics/dist

  restore_cache_dist_directories:
    description: Restores all the dist dircetories
    steps:
      - restore_cache:
          name: Restore molecules Cache
          keys:
            - build-cache-molecules-master-
      - restore_cache:
          name: Restore atoms Cache
          keys:
            - build-cache-atoms-master-
      - restore_cache:
          name: Restore organisms Cache
          keys:
            - build-cache-organisms-master-
      - restore_cache:
          name: Restore pages Cache
          keys:
            - build-cache-templates-master-
      - restore_cache:
          name: Restore pages Cache
          keys:
            - build-cache-pages-master-
      - restore_cache:
          name: Restore services Cache
          keys:
            - build-cache-services-master-

  build_packages:
    description: Builds all components in the monorepo
    steps:
      - run_command:
          command_description: Build all components
          command_name: build

  build_component_type_packages:
    description: Builds a component type in the monorepo
    parameters:
      component_type:
        type: string
        default: global
    steps:
      - run_command:
          command_description: Build << parameters.component_type >> components
          command_name: ci:build:<< parameters.component_type >>

  lint_all_components:
    description: Lints all components in the monorepo
    steps:
      - run_command:
          command_description: Lint all components
          command_name: lint

  lint_component_type_packages:
    description: Lints << parameters.component_type >> components
    parameters:
      component_type:
        type: string
        default: global
    steps:
      - run_command:
          command_description: Run linting for << parameters.component_type >> components
          command_name: ci:lint:<< parameters.component_type >>

  unit_integration_tests:
    description: Run Unit / Integration Tests
    parameters:
      component_type:
        type: string
    steps:
      - run_command:
          command_description: Run unit / integration tests for packages
          command_name: "ci:test:<< parameters.component_type >>"

  build_storybook:
    description: Build Storybook for all UI tests
    steps:
      - when:
          condition: << pipeline.parameters.global_change >>
          steps:
            - run:
                name: Build Storybook for all UI tests
                command: yarn storybook:build
      - when:
          condition:
            not: << pipeline.parameters.global_change >>
          steps:
            - run:
                name: Build Storybook for changed package UI tests
                command: yarn storybook:build-changed

  component_tests:
    description: Run Component Tests
    parameters:
      component_type:
        type: string
    steps:
      - run_command:
          command_description: Run component tests for packages
          command_name: "ci:test-component:chrome:<< parameters.component_type >>"

  accessibility_tests:
    description: Run Accessibility Tests
    parameters:
      component_type:
        type: string
    steps:
      - run_command:
          command_description: Run accessibility tests for packages
          command_name: "ci:test-a11y:chrome:<< parameters.component_type >>"

  visual_regression_tests:
    description: Run Percy Visual Regression Tests
    parameters:
      component_type:
        type: string
    steps:
      - run:
          name: Run Percy visual regression tests for packages
          command: |
            VISUAL_TESTS=`node ./visual-regression-preflight.js`

            if [ "${VISUAL_TESTS}" == "true" ];
            then
              if [ "${RUN_ALL}" == "true" ];
              then
                yarn ci:test:visual:<< parameters.component_type >>
              else
                yarn ci:test:visual:<< parameters.component_type >> --since master...HEAD
              fi
            else
              echo Skipping visual regression tests because PR is either in draft mode or has wip label applied
            fi

  slack_notify_fail:
    description: Sends a slack notifaction on job failure
    steps:
      - slack/notify:
          branch_pattern: master
          event: fail
          custom: |
            {
              "attachments": [
                {
                  "blocks": [
                    {
                      "type": "section",
                      "text": {
                        "type": "mrkdwn",
                        "text": "Your job *${CIRCLE_JOB}* has failed ⚠️"
                      },
                      "fields": [
                        {
                          "type": "mrkdwn",
                          "text": "*Author*: ${CIRCLE_USERNAME}"
                        },
                        {
                          "type": "mrkdwn",
                          "text": "*Commit*: ${CIRCLE_SHA1}"
                        }
                      ],
                      "accessory": {
                        "type": "image",
                        "image_url": "https://user-images.githubusercontent.com/26894168/101182589-31708380-3646-11eb-80d5-b174d47bf7fb.png",
                        "alt_text": "Fozzie Logo"
                      }
                    },
                    {
                      "type": "actions",
                      "elements": [
                        {
                          "type": "button",
                          "text": {
                            "type": "plain_text",
                            "text": "View Job"
                          },
                          "url": "${CIRCLE_BUILD_URL}"
                        }
                      ]
                    }
                  ],
                  "color": "danger"
                }
              ]
            }

  slack_notify_success:
    description: Sends a slack notifaction on job success
    steps:
      - slack/notify:
          branch_pattern: master
          event: pass
          custom: |
            {
              "attachments": [
                {
                  "blocks": [
                    {
                      "type": "section",
                      "text": {
                        "type": "mrkdwn",
                        "text": "Your job *${CIRCLE_JOB}* has succeeded 🎉"
                      },
                      "fields": [
                        {
                          "type": "mrkdwn",
                          "text": "*Author*: ${CIRCLE_USERNAME}"
                        },
                        {
                          "type": "mrkdwn",
                          "text": "*Commit*: ${CIRCLE_SHA1}"
                        }
                      ],
                      "accessory": {
                        "type": "image",
                        "image_url": "https://user-images.githubusercontent.com/26894168/101182641-4220f980-3646-11eb-8782-29a6a2213815.png",
                        "alt_text": "Fozzie Logo"
                      }
                    },
                    {
                      "type": "actions",
                      "elements": [
                        {
                          "type": "button",
                          "text": {
                            "type": "plain_text",
                            "text": "View Job"
                          },
                          "url": "${CIRCLE_BUILD_URL}"
                        }
                      ]
                    }
                  ],
                  "color": "good"
                }
              ]
            }

executors:
  node:
    docker:
      # specify the version you desire here
      - image: circleci/node:14.18.1-browsers # For latest available images check – https://circleci.com/docs/2.0/docker-image-tags.json

jobs:

  working_directory: ~/repo

  install:
    executor: node
    environment:
      # required to prevent ENOMEM errors
      LERNA_ARGS: --concurrency 1
    steps:
      - checkout
      # Restore 'master' cache
      - restore_cache_dist_directories
      - install_node_dependencies
      - persist_to_workspace:
          root: .
          paths:
            - '*'
      - slack_notify_fail
      - slack_notify_success

  danger-checks:
    executor: node
    steps:
      - attach_workspace:
          at: .
      - run: # Run PR Checks
         name: Run PR Checks
         command: yarn danger ci --failOnErrors
      - slack_notify_fail
      - slack_notify_success

  build:
    executor: node
    environment:
      # required to prevent ENOMEM errors
      LERNA_ARGS: --concurrency 1
    parameters:
      component_type:
        type: string
        # Setting a default value so this job can be used by both workflows. Value will always be overridden at workflow level.
        default: global
      component_type_folder:
        type: string
        # Setting a default value so this job can be used by both workflows. Value will always be overridden at workflow level.
        default: global
    steps:
      - attach_workspace:
          at: .
        # If global_change - Build + Lint all packages across multiple jobs - based on atomic level.
      - when:
          condition: << pipeline.parameters.global_change >>
          steps:
            - build_component_type_packages:
                component_type: << parameters.component_type >>
            - lint_component_type_packages:
                component_type: << parameters.component_type >>
            - persist_to_workspace:
                root: << parameters.component_type_folder >>
                paths:
                  - '*'
            # Only save cache dist if master branch
            - when:
                condition:
                  equal: [ master, << pipeline.git.branch >> ]
                steps:
                  - save_cache_dist_directories
      # Else Build + Lint changed packages in a single job.
      - when:
          condition:
            not: << pipeline.parameters.global_change >>
          steps:
            - build_packages
            # Persist whole workspace
            - persist_to_workspace:
                root: .
                paths:
                  - '*'
            # Lint components based on atomic level - e.g ci:lint:atoms
            - lint_all_components
      - slack_notify_fail
      - slack_notify_success

  bundlewatch:
    executor: node
    environment:
      # required to prevent ENOMEM errors
      LERNA_ARGS: --concurrency 1
    steps:
      - attach_workspace:
          at: .
      - run:
         name: Run Bundlewatch checks
         command: yarn bundlewatch
      - slack_notify_fail
      - slack_notify_success

  unit-tests:
    executor: node
    parameters:
      component_type:
        type: string
    environment:
      LERNA_ARGS: --concurrency 1
    steps:
      - attach_workspace:
          at: .
      - unit_integration_tests:
          component_type: << parameters.component_type >>

  browser-tests:
    executor: node
    parameters:
      component_type:
        type: string
    steps:
      - attach_workspace:
          at: .
      - run: # Install Component Test Dependencies
          name: Install Component Test Dependencies
          command: yarn global add @vue/cli @vue/cli-service-global http-server
      - build_storybook
      - run: # Serve Storybook
          name: Serve Storybook
          command: yarn storybook:serve-static
          background: true
      - component_tests:
          component_type: << parameters.component_type >>
      - accessibility_tests:
          component_type: << parameters.component_type >>
      - visual_regression_tests:
          component_type: << parameters.component_type >>
      - run:
          name: Allure - Generate Test Results
          command: yarn allure:generate
          when: always
      - store_artifacts:
          path: allure-report
      - store_artifacts:
          path: test/results/axe-violations
      - slack_notify_fail
      - slack_notify_success

  deploy-storybook:
    executor: node
    environment:
      # required to prevent ENOMEM errors
      LERNA_ARGS: --concurrency 1
    steps:
      - checkout
      - install_node_dependencies
      - restore_cache_dist_directories
      - run:
          name: Deploy
          command: yarn storybook:deploy
      - slack_notify_fail
      - slack_notify_success

  publish-to-npm:
    executor: node
    steps:
      - attach_workspace:
          at: .
      - run:
          name: Auth With NPM
          command: echo "//registry.npmjs.org/:_authToken=$npm_TOKEN" > .npmrc
      - run:
          name: Publish unreleased package versions to npm
          command: npx lerna publish from-package --ignore-scripts --yes
      - slack_notify_fail
      - slack_notify_success

workflows:
 
  # Workflow that's run for non-global changes
  build_and_test_packages:
    when:
      not: << pipeline.parameters.global_change >>
    jobs:
      - install:
          context: web-core
          filters:
            branches:
              ignore: ['gh-pages', 'master']
      - danger-checks:
          name: danger-checks
          context: web-core
          filters:
            branches:
              ignore: ['gh-pages', 'master']
          requires:
            - install
      - unit-tests:
          matrix:
            parameters:
              component_type: ['tools', 'services', 'atoms', 'molecules', 'organisms', 'pages', 'templates']
          context: web-core
          filters:
            branches:
              ignore: ['gh-pages', 'master']
          requires:
            - danger-checks
      - build:
          name: build
          context: web-core
          filters:
            branches:
              ignore: ['gh-pages', 'master']
          requires:
            - unit-tests-tools
            - unit-tests-services
            - unit-tests-atoms
            - unit-tests-molecules
            - unit-tests-organisms
            - unit-tests-pages
            - unit-tests-templates

      - bundlewatch:
          name: bundlewatch
          context: web-core
          filters:
            branches:
              ignore: ['gh-pages', 'master']
          requires:
            - build
      - browser-tests:
          matrix:
            parameters:
              component_type: ['atoms', 'molecules', 'organisms', 'pages']
          context: web-core
          filters:
            branches:
              ignore: ['gh-pages', 'master']
          requires:
            - bundlewatch

  build_and_test_global:
    when:
      or: # Either must be true to trigger
        - equal: [ master, << pipeline.git.branch >> ]
        - << pipeline.parameters.global_change >>
    jobs:
      - install:
          context: web-core
          filters:
            branches:
              ignore: [ 'gh-pages' ]
      - danger-checks:
          name: danger-checks
          context: web-core
          filters:
            branches:
              ignore: ['gh-pages']
          requires:
            - install

      - unit-tests:
          matrix:
            parameters:
              component_type: ['tools', 'services', 'atoms', 'molecules', 'organisms', 'pages', 'templates']
          context: web-core
          filters:
            branches:
              ignore: ['gh-pages']
          requires:
            - danger-checks

      - build:
          component_type: 'services'
          component_type_folder: 'packages/services'
          name: build-services
          context: web-core
          filters:
            branches:
              ignore: ['gh-pages']
          requires:
            - unit-tests-services

      - build:
          component_type: 'tools'
          component_type_folder: 'packages/tools'
          name: build-tools
          context: web-core
          filters:
            branches:
              ignore: ['gh-pages']
          requires:
            - unit-tests-tools

      - build:
          component_type: 'atoms'
          component_type_folder: 'packages/components/atoms'
          name: build-atoms
          context: web-core
          filters:
            branches:
              ignore: ['gh-pages']
          requires:
            - build-tools
            - build-services
            - unit-tests-atoms

      - build:
          component_type: 'molecules'
          component_type_folder: 'packages/components/molecules'
          name: build-molecules
          context: web-core
          filters:
            branches:
              ignore: ['gh-pages']
          requires:
            - build-atoms
            - unit-tests-molecules

      - build:
          component_type: 'organisms'
          component_type_folder: 'packages/components/organisms'
          name: build-organisms
          context: web-core
          filters:
            branches:
              ignore: ['gh-pages']
          requires:
            - build-molecules
            - unit-tests-organisms

      - build:
          component_type: 'templates'
          component_type_folder: 'packages/components/templates'
          name: build-templates
          context: web-core
          filters:
            branches:
              ignore: ['gh-pages']
          requires:
            - build-molecules
            - unit-tests-templates

      - build:
          component_type: 'pages'
          component_type_folder: 'packages/components/pages'
          name: build-pages
          context: web-core
          filters:
            branches:
              ignore: ['gh-pages']
          requires:
            - build-organisms
            - unit-tests-pages

      - bundlewatch:
          name: bundlewatch
          context: web-core
          filters:
            branches:
              ignore: ['gh-pages']
          requires:
            - build-pages
            - build-templates

      - browser-tests:
          matrix:
            parameters:
              component_type: ['atoms', 'molecules', 'organisms', 'pages']
          context: web-core
          filters:
            branches:
              ignore: ['gh-pages']
          requires:
            - build-pages
            - build-templates
            - bundlewatch

      - publish-to-npm:
          context: web-core
          filters:
            branches:
              only: master
          requires:
            - browser-tests-atoms
            - browser-tests-molecules
            - browser-tests-organisms
            - browser-tests-pages
            - unit-tests-tools
            - unit-tests-services
            - unit-tests-templates

  deploy-storybook:
    jobs:
      - deploy-storybook:
          context: web-core
          filters:
            branches:
              only: master